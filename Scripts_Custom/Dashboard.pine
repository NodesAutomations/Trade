//@version=5
indicator("Dashboard",overlay= true)
import vkpunique/PineHelper/9 as ph

//Current Holding
var holdingMap= map.new<string,ph.Trade>()
holdingMap.put("LIKHITHA",ph.Trade.new(482.81,"20240712"))
holdingMap.put("JINDALSAW",ph.Trade.new(663.65,"20240822"))
holdingMap.put("PFS",ph.Trade.new(59.12,"20240827"))

var triggerMap= map.new<string,float>()
triggerMap.put("GODIGIT",378)
triggerMap.put("AFIL",134)
triggerMap.put("MOTILALOFS",706)
triggerMap.put("GEOJITFSL",115)
triggerMap.put("BLS",403)
triggerMap.put("SUBROS",760)
triggerMap.put("CAPLIPOINT",1780)
triggerMap.put("PFS",59)
triggerMap.put("BIKAJI",860)
triggerMap.put("NSIL",4760)
triggerMap.put("HEROMOTOCO",5450)
triggerMap.put("INOXWIND",230)
triggerMap.put("KPITTECH",1870)
triggerMap.put("MANAPPURAM",218)
triggerMap.put("WABAG",1380)
triggerMap.put("GENESYS",739)
triggerMap.put("RKFORGE",973)
triggerMap.put("SHARDAMOTR",2780)
triggerMap.put("DLINKINDIA",638)
triggerMap.put("IONEXCHANG",747)
triggerMap.put("JYOTHYLAB",574)
triggerMap.put("IREDA",266)
triggerMap.put("METROBRAND",1402)
triggerMap.put("KELLTONTEC",169)
triggerMap.put("CARTRADE",931)
triggerMap.put("ROSSELLIND",612)
triggerMap.put("MAYURUNIQ",675)
triggerMap.put("TVSSRICHAK",5097)
triggerMap.put("MAZDOCK",4640)

//Industry Trend
GetIndustryTrend(string industry)=>
	var industryMap= map.new<string,int>()
    industryMap.put("Agricultural Commodities/Milling",1)
    industryMap.put("Alternative Power Generation",1)
    industryMap.put("Apparel/Footwear",1)
    industryMap.put("Auto Parts: OEM",1)
    industryMap.put("Building Products",1)
    industryMap.put("Chemicals: Agricultural",1)
    industryMap.put("Chemicals: Specialty",1)
    industryMap.put("Data Processing Services",1)
    industryMap.put("Electronic Equipment/Instruments",1)
    industryMap.put("Electronic Production Equipment",1)
    industryMap.put("Finance/Rental/Leasing",1)
    industryMap.put("Financial Conglomerates",1)
    industryMap.put("Hospital/Nursing Management",1)
    industryMap.put("Household/Personal Care",1)
    industryMap.put("Industrial Specialties",1)
    industryMap.put("Information Technology Services",1)
    industryMap.put("Internet Software/Services",1)
    industryMap.put("Investment Banks/Brokers",1)
    industryMap.put("Industrial Machinery",1)
    industryMap.put("Medical/Nursing Services",1)
    industryMap.put("Motor Vehicles",1)
    industryMap.put("Packaged Software",1)
    industryMap.put("Steel",1)
    industryMap.put("Textiles",1)
    industryMap.put("Trucks/Construction/Farm Machinery",1)

	industryMap.contains(industry)?industryMap.get(industry):0

//General variables
[dailyOpen,dailyHigh,dailyLow,dailyClose] = request.security(syminfo.tickerid, "1D", [open,high,low,close])

//Market Cap Value
series float TSOFQ = request.financial(syminfo.tickerid, "TOTAL_SHARES_OUTSTANDING", "FQ",ignore_invalid_symbol=true)
series float TSOFY =request.financial(syminfo.tickerid, "TOTAL_SHARES_OUTSTANDING", "FY",ignore_invalid_symbol=true)
MarketCap = ph.IsStock()? (na(TSOFQ)?TSOFY:TSOFQ) * close:0

//Free Float Value
series float FSOFY =nz(request.financial(syminfo.tickerid, 'FLOAT_SHARES_OUTSTANDING', 'FY',ignore_invalid_symbol=true))
FreeFloat=ph.IsStock()? FSOFY*ta.vwap:0

//Fno IsStock
bool isFnoStock= ph.IsFNOStock(syminfo.ticker)

////EMA Calculation
float ema10 = request.security(syminfo.tickerid, "1D",ta.ema(close, 10))
float ema21 = request.security(syminfo.tickerid, "1D",ta.ema(close, 21))
float ema50 = request.security(syminfo.tickerid, "1D",ta.ema(close, 50))

bool IsTrendingEMA=(ema10>ema21) and (ema21>ema50)
float ema10_Percentate=ph.Percentage(dailyClose,ema10)
float ema21_Percentate=ph.Percentage(dailyClose,ema21)
float ema50_Percentate=ph.Percentage(dailyClose,ema50)

////Ath Calculatoin
GetAllTimeHigh(dataSeries = high) =>
    highestHTF = request.security(syminfo.tickerid, "D", 
         ph.GetChartHighest(dataSeries)[1], lookahead=barmerge.lookahead_on)
    highestChartTF = ph.GetChartHighest(dataSeries)
    math.max(highestHTF, highestChartTF)

ath_Percentage=ph.Percentage(dailyClose,GetAllTimeHigh()[0])

//// ADR Calculation
adr_Percentage = (request.security(syminfo.tickerid, "1D",ta.sma(high/low, 20)) - 1)

//Trigger Calculation
float trigger=triggerMap.contains(syminfo.ticker)?triggerMap.get(syminfo.ticker):0
trigger_Percentage=trigger>0? ph.Percentage(close,trigger):0
GetTriggerBGColor(x)=>x>=0.02?color.red:x>=-0.02?color.green:color(na)

// Gain 
float buyPrice=holdingMap.contains(syminfo.ticker)?holdingMap.get(syminfo.ticker).BuyPrice:0
float gain_Percentage=buyPrice>0?ph.Percentage(close,buyPrice) :0

//NOD
currentDate = timestamp(year(timenow), month(timenow), dayofmonth(timenow), 0, 0)

dateString = holdingMap.contains(syminfo.ticker)?holdingMap.get(syminfo.ticker).OrderDate: str.format_time(currentDate, "yyyyMMdd", syminfo.timezone)

dyear =int( str.tonumber(str.substring(dateString, 0, 4)))
dmonth = int( str.tonumber(str.substring(dateString, 4, 6)))
dday = int( str.tonumber(str.substring(dateString, 6, 8)))

startDate= timestamp(dyear, dmonth,dday, 0, 0)
int NOD= ((currentDate-startDate)/(24 * 60 * 60 * 1000))+1

//// Table Generation
int colId=0
if barstate.islast 
    var dashboard= table.new("top_center",20,2)
 
    ph.VerticleCell(dashboard,colId,"MCAP",ph.ToCrore(MarketCap), ph.GetBGColor(ph.RatioCrore(MarketCap),500,1000,10000,100000,200000))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId, "FF",ph.ToCrore(FreeFloat), ph.GetBGColor(ph.RatioCrore(FreeFloat),300,500,1000,10000,100000))
    colId:=colId+1

    ph.VerticleCellBlank(dashboard,colId)
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"EMA",IsTrendingEMA?"Pass":"Fail",ph.GetBGColor(IsTrendingEMA))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"EMA 10",ph.ToPercentage(ema10_Percentate),ph.GetBGColor(ema10_Percentate,-0.01,0,0.03,0.1,0.15))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"EMA 21",ph.ToPercentage(ema21_Percentate),ph.GetBGColor(ema10_Percentate,-0.01,0,0.03,0.1,0.15))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"EMA 50",ph.ToPercentage(ema50_Percentate),ph.GetBGColor(ema10_Percentate,-0.01,0,0.03,0.1,0.15))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"ATH",ph.ToPercentage(ath_Percentage),ph.GetBGColor(ath_Percentage,-0.2,-0.15,-0.1,-0.01,-0.005))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"ADR",ph.ToPercentage(adr_Percentage),ph.GetBGColorUp(adr_Percentage,0,0.025,0.05))
    colId:=colId+1

    ph.VerticleCellBlank(dashboard,colId)
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"FNO",isFnoStock?"Yes":"No",ph.GetBGColor3(isFnoStock?-1:0))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"Industry",syminfo.industry,ph.GetBGColor3(GetIndustryTrend(syminfo.industry)))
    colId:=colId+1

    ph.VerticleCellBlank(dashboard,colId)
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"GTT",trigger>0?ph.ToPercentage(trigger_Percentage):"-",ph.GetBGColorDown(trigger_Percentage,0.02,0,-0.02))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"Gain",buyPrice>0?ph.ToPercentage(gain_Percentage):"-",ph.GetBGColorUp(gain_Percentage,-0.03,0,0.06))
    colId:=colId+1

    ph.VerticleCell(dashboard,colId,"NOD",buyPrice>0?str.tostring(NOD):"-",color(na))
    colId:=colId+1
